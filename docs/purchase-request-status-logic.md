# Логика установки статусов для заявок на закупку

## Таблица всех статусов

| Enum константа | Отображаемое название | Описание |
|---------------|----------------------|----------|
| `ON_APPROVAL` | Заявка на согласовании | Есть активное согласование (назначено, но не завершено) |
| `ON_APPROVAL_FINAL` | Заявка на утверждении | Есть активное утверждение (назначено, но не завершено) |
| `APPROVED` | Заявка утверждена | Есть завершенное утверждение с положительным результатом |
| `COORDINATED` | Согласована | Заявка согласована (используется редко) |
| `NOT_COORDINATED` | Заявка не согласована | Хотя бы одно согласование не согласовано |
| `NOT_APPROVED` | Заявка не утверждена | Хотя бы одно согласование не утверждено |
| `PROJECT` | Проект | Заявка в статусе "Проект" |
| `SPECIFICATION_CREATED` | Спецификация создана | Для заказов (requiresPurchase === false): есть спецификация |
| `SPECIFICATION_CREATED_ARCHIVE` | Спецификация создана - Архив | Для заказов: есть проектная спецификация старше 60 рабочих дней |
| `SPECIFICATION_SIGNED` | Спецификация подписана | Для заказов: есть подписанная спецификация |
| `SPECIFICATION_NOT_COORDINATED` | Спецификация не согласована | Для заказов: есть не согласованная спецификация |
| `PURCHASE_CREATED` | Закупка создана | Для закупок (requiresPurchase !== false): есть связанная закупка |
| `PURCHASE_NOT_COORDINATED` | Закупка не согласована | Для закупок: связанная закупка имеет статус "Не согласовано" |
| `PURCHASE_COMPLETED` | Закупка завершена | Для закупок: все связанные закупки завершены |
| `CONTRACT_CREATED` | Договор создан | Для закупок: есть договор (не спецификация) |
| `CONTRACT_SIGNED` | Договор подписан | Для закупок: все договоры подписаны |

## Приоритет установки статусов (по убыванию)

Статус устанавливается в соответствии с приоритетом. Проверка выполняется сверху вниз, и первый подходящий статус устанавливается.

### 1. **Спецификация подписана** (высший приоритет для заказов)
- **Условие**: `hasSignedSpecification === true`
- **Тип заявки**: Заказы (`requiresPurchase === false`)
- **Статус**: `SPECIFICATION_SIGNED` ("Спецификация подписана")
- **Проверка**: Есть спецификация со статусом `SIGNED`

### 2. **Договор подписан** (высший приоритет для закупок)
- **Условие**: `hasContracts === true && allContractsSigned === true && requiresPurchase !== false`
- **Тип заявки**: Закупки (`requiresPurchase !== false`)
- **Статус**: `CONTRACT_SIGNED` ("Договор подписан")
- **Проверка**: Есть договоры (не спецификации) и все они имеют статус `SIGNED`

### 3. **Спецификация не согласована** (высокий приоритет для заказов)
- **Условие**: `hasNotCoordinatedSpecification === true`
- **Тип заявки**: Заказы (`requiresPurchase === false`)
- **Статус**: `SPECIFICATION_NOT_COORDINATED` ("Спецификация не согласована")
- **Проверка**: Есть спецификация со статусом `NOT_COORDINATED`

### 4. **Спецификация создана - Архив** (высокий приоритет для заказов)
- **Условие**: `hasArchivedSpecification === true`
- **Тип заявки**: Заказы (`requiresPurchase === false`)
- **Статус**: `SPECIFICATION_CREATED_ARCHIVE` ("Спецификация создана - Архив")
- **Проверка**: Есть проектная спецификация (`PROJECT`) и прошло более 60 рабочих дней с даты создания заявки

### 5. **Спецификация создана** (высокий приоритет для заказов)
- **Условие**: `hasSpecification === true && requiresPurchase === false`
- **Тип заявки**: Заказы (`requiresPurchase === false`)
- **Статус**: `SPECIFICATION_CREATED` ("Спецификация создана")
- **Проверка**: Есть спецификация (document_form = 'Спецификация')

### 6. **Закупка не согласована** (высокий приоритет для закупок)
- **Условие**: `hasNotCoordinatedPurchase === true`
- **Тип заявки**: Закупки (`requiresPurchase !== false`)
- **Статус**: `PURCHASE_NOT_COORDINATED` ("Закупка не согласована")
- **Проверка**: Связанная закупка имеет статус `NOT_COORDINATED`

### 7. **Договор создан** (высокий приоритет для закупок)
- **Условие**: `hasContracts === true && requiresPurchase !== false`
- **Тип заявки**: Закупки (`requiresPurchase !== false`)
- **Статус**: `CONTRACT_CREATED` ("Договор создан")
- **Проверка**: Есть договоры (не спецификации)

### 8. **Закупка завершена** (высокий приоритет для закупок)
- **Условие**: `allPurchasesCompleted === true && requiresPurchase !== false`
- **Тип заявки**: Закупки (`requiresPurchase !== false`)
- **Статус**: `PURCHASE_COMPLETED` ("Закупка завершена")
- **Проверка**: Все связанные закупки имеют статус `COMPLETED`

### 9. **Закупка создана** (средний приоритет для закупок)
- **Условие**: `hasPurchase === true`
- **Тип заявки**: Закупки (`requiresPurchase !== false`)
- **Статус**: `PURCHASE_CREATED` ("Закупка создана")
- **Проверка**: Есть связанная закупка (даже если заявка утверждена)

### 10. **Заявка не утверждена** (низкий приоритет)
- **Условие**: `hasNotApproved === true`
- **Тип заявки**: Все
- **Статус**: `NOT_APPROVED` ("Заявка не утверждена")
- **Проверка**: Хотя бы одно согласование имеет результат, содержащий "не утвержден", "не утверждено", "не утверждена"

### 11. **Заявка не согласована** (низкий приоритет)
- **Условие**: `hasNotCoordinated === true`
- **Тип заявки**: Все
- **Статус**: `NOT_COORDINATED` ("Заявка не согласована")
- **Проверка**: Хотя бы одно согласование имеет результат, содержащий "не согласован", "не согласована", "отклонен", "отклонена"

### 12. **Заявка утверждена** (низкий приоритет)
- **Условие**: `hasCompletedFinalApproval === true`
- **Тип заявки**: Все
- **Статус**: `APPROVED` ("Заявка утверждена")
- **Проверка**: Есть завершенное утверждение (stage = "Утверждение заявки на ЗП" или "Утверждение заявки на ЗП (НЕ требуется ЗП)") с положительным результатом или без результата

### 13. **Заявка на утверждении** (низкий приоритет)
- **Условие**: `hasActiveFinalApproval === true`
- **Тип заявки**: Все
- **Статус**: `ON_APPROVAL_FINAL` ("Заявка на утверждении")
- **Проверка**: Есть активное утверждение (назначено, но не завершено)

### 14. **Заявка на согласовании** (низший приоритет)
- **Условие**: `hasActiveApproval === true`
- **Тип заявки**: Все
- **Статус**: `ON_APPROVAL` ("Заявка на согласовании")
- **Проверка**: Есть активное согласование (назначено, но не завершено)

## Детали проверок

### Проверка согласований
- **Активное согласование**: `assignmentDate != null && completionDate == null`
- **Завершенное согласование**: `completionDate != null`
- **Утверждение**: `stage == "Утверждение заявки на ЗП" || stage == "Утверждение заявки на ЗП (НЕ требуется ЗП)"`
- **Не согласовано**: `completionResult` содержит "не согласован", "не согласована", "отклонен", "отклонена"
- **Не утверждено**: `completionResult` содержит "не утвержден", "не утверждено", "не утверждена"

### Проверка спецификаций (для заказов)
- **Есть спецификация**: `document_form = 'Спецификация'` в таблице `contracts`
- **Подписанная спецификация**: `status = 'SIGNED'`
- **Не согласованная спецификация**: `status = 'NOT_COORDINATED'`
- **Проектная спецификация**: `status = 'PROJECT'`
- **Архивная спецификация**: Проектная спецификация + прошло > 60 рабочих дней с даты создания заявки

### Проверка закупок (для закупок)
- **Есть закупка**: Есть запись в таблице `purchases` с `purchase_request_id`
- **Закупка не согласована**: `status = 'NOT_COORDINATED'`
- **Все закупки завершены**: Все закупки с непустым статусом имеют `status = 'COMPLETED'`

### Проверка договоров (для закупок)
- **Есть договор**: Есть запись в таблице `contracts` с `document_form != 'Спецификация'`
- **Договор подписан**: Все договоры имеют `status = 'SIGNED'`
- **Связь договоров**: 
  - Напрямую через `purchase_request_id`
  - Через закупки по `contractInnerIds`

## Файлы с реализацией

- **Enum статусов**: `backend/src/main/java/com/uzproc/backend/entity/PurchaseRequestStatus.java`
- **Сервис обновления статусов**: `backend/src/main/java/com/uzproc/backend/service/PurchaseRequestStatusUpdateService.java`
- **Метод обновления**: `updateStatus(Long idPurchaseRequest)`

## Примечания

1. Статус обновляется только если он изменился
2. Для заказов (`requiresPurchase === false`) приоритет имеют статусы, связанные со спецификациями
3. Для закупок (`requiresPurchase !== false`) приоритет имеют статусы, связанные с закупками и договорами
4. Рабочие дни считаются без учета субботы и воскресенья
5. Проверка архивной спецификации использует дату создания заявки (`purchaseRequestCreationDate`) или дату создания спецификации как fallback
