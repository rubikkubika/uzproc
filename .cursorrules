# Правила для Cursor AI

## Деплой на сервер
Когда пользователь упоминает "деплой", "deploy", "опубликовать", "публикация", "выложить на сервер" или похожие фразы, необходимо автоматически выполнить скрипт деплоя:

1. Выполнить PowerShell скрипт `scripts/deploy-simple.ps1` из корня проекта
2. Скрипт автоматически:
   - Соберет Docker образы (frontend, backend)
   - Сохранит их в tar файлы
   - Скопирует образы и `docker-compose.yml` на сервер (devops@10.123.48.62)
   - Обновит контейнеры на сервере

**ВАЖНО:** При деплое обязательно копировать обновленный `docker-compose.yml` на сервер, чтобы конфигурация сервисов была актуальной.

**КРИТИЧЕСКИ ВАЖНО:** При деплое НИКОГДА не выполнять коммит (`git commit`) и пуш (`git push`) изменений в Git, если пользователь явно не просит об этом. Деплой выполняется только через скрипт, без изменений в репозитории. Даже если есть незакоммиченные изменения, их НЕ нужно коммитить и пушить автоматически при деплое.

Команда для выполнения:
```powershell
.\scripts\deploy-simple.ps1
```

Не нужно спрашивать подтверждение - просто выполнить скрипт при упоминании деплоя.

## Запуск сервисов
Когда пользователь просит запустить сервис (фронтенд, бэкенд или оба), необходимо автоматически:

1. **Проверить и остановить локальные процессы:**
   - Проверить наличие запущенных Java процессов (для бэкенда)
   - Проверить наличие запущенных Node.js процессов (для фронтенда)
   - Остановить найденные процессы перед запуском

2. **Проверить и остановить Docker контейнеры:**
   - Проверить статус контейнеров через `docker compose ps`
   - Остановить и удалить существующие контейнеры через `docker compose stop` и `docker compose rm -f`
   - Это нужно делать для всех сервисов (frontend, backend, postgres)

3. **Запустить сервисы:**
   - После очистки запустить нужные сервисы через `docker compose up -d` или локально, в зависимости от запроса пользователя

Примеры фраз, которые должны триггерить это правило:
- "запусти сервис"
- "запусти бэкенд"
- "запусти фронтенд"
- "запусти локально"
- "запусти в докере"
- "перезапусти сервис"
- "перезапусти бэкенд"
- и похожие запросы

Не нужно спрашивать подтверждение - автоматически проверять и останавливать существующие процессы/контейнеры перед запуском.

## Локальный запуск без Docker

Когда пользователь просит запустить сервисы локально без Docker ("запусти локально без докера", "запусти без docker" и т.д.), необходимо:

### Подготовка окружения

1. **Для фронтенда:**
   - **macOS (с nvm):** Загрузить nvm: `source ~/.nvm/nvm.sh` (если npm не в PATH)
   - **Windows:** Убедиться, что Node.js установлен и доступен в PATH
   - Проверить npm: `npm --version` (работает на обеих платформах)

2. **Для бэкенда:**
   - **macOS/Linux:** Проверить Maven: `which mvn` или `mvn --version`
   - **Windows:** Проверить Maven: `where mvn` или `mvn --version`
   - Убедиться, что Java 17+ установлена: `java -version` (работает на всех платформах)

### Запуск PostgreSQL

PostgreSQL должен быть запущен в Docker (инфраструктура):
```bash
docker compose up -d postgres
```

### Запуск фронтенда

1. **Остановить существующие процессы:**
   - **macOS/Linux:**
     ```bash
     pkill -f "next dev" || true
     kill -9 $(lsof -ti:3000) 2>/dev/null || true
     ```
   - **Windows (PowerShell):**
     ```powershell
     Get-Process | Where-Object {$_.ProcessName -like "*node*" -and $_.CommandLine -like "*next dev*"} | Stop-Process -Force -ErrorAction SilentlyContinue
     $port = Get-NetTCPConnection -LocalPort 3000 -ErrorAction SilentlyContinue
     if ($port) { Stop-Process -Id $port.OwningProcess -Force -ErrorAction SilentlyContinue }
     ```
   - **Windows (CMD):**
     ```cmd
     taskkill /F /IM node.exe /FI "WINDOWTITLE eq *next dev*" 2>nul
     for /f "tokens=5" %a in ('netstat -aon ^| findstr :3000') do taskkill /F /PID %a 2>nul
     ```

2. **Запустить фронтенд:**
   ```bash
   cd frontend
   npm run dev
   ```
   - Фронтенд будет доступен на http://localhost:3000
   - Скрипты в `package.json` используют стандартные команды (`next dev`), которые работают на Mac и Windows

### Запуск бэкенда

1. **Остановить существующие процессы:**
   - **macOS/Linux:**
     ```bash
     pkill -f "spring-boot:run" || true
     kill -9 $(lsof -ti:8080) 2>/dev/null || true
     ```
   - **Windows (PowerShell):**
     ```powershell
     Get-Process | Where-Object {$_.ProcessName -like "*java*" -and $_.CommandLine -like "*spring-boot*"} | Stop-Process -Force -ErrorAction SilentlyContinue
     $port = Get-NetTCPConnection -LocalPort 8080 -ErrorAction SilentlyContinue
     if ($port) { Stop-Process -Id $port.OwningProcess -Force -ErrorAction SilentlyContinue }
     ```
   - **Windows (CMD):**
     ```cmd
     taskkill /F /IM java.exe /FI "WINDOWTITLE eq *spring-boot*" 2>nul
     for /f "tokens=5" %a in ('netstat -aon ^| findstr :8080') do taskkill /F /PID %a 2>nul
     ```

2. **Запустить бэкенд:**
   ```bash
   cd backend
   mvn spring-boot:run
   ```
   - Бэкенд будет доступен на http://localhost:8080/api
   - Health check: http://localhost:8080/api/health
   - Команда `mvn spring-boot:run` работает одинаково на всех платформах

### Проверка статуса

После запуска проверить:
- **Фронтенд:**
  - macOS/Linux: `curl http://localhost:3000` (ожидается HTTP 307 или 200)
  - Windows: `curl http://localhost:3000` или `Invoke-WebRequest http://localhost:3000` (PowerShell)
- **Бэкенд:**
  - macOS/Linux: `curl http://localhost:8080/api/health` (ожидается `{"service":"uzproc-backend","status":"UP"}`)
  - Windows: `curl http://localhost:8080/api/health` или `Invoke-WebRequest http://localhost:8080/api/health` (PowerShell)

### Важные замечания

- **npm должен быть в PATH:**
  - macOS: настроено через `.bash_profile` и `.zshrc` для автоматической загрузки nvm
  - Windows: Node.js должен быть установлен и добавлен в PATH системы (обычно делается автоматически при установке)
- PostgreSQL запускается в Docker, так как это инфраструктура (команда `docker compose up -d postgres` работает одинаково на всех платформах)
- При перезапуске всегда останавливать старые процессы перед запуском новых (использовать соответствующие команды для вашей ОС)
- Запускать сервисы в фоновом режиме (`is_background: true`) или с перенаправлением вывода для логирования
- На Windows рекомендуется использовать PowerShell для более удобной работы с процессами и портами

## Создание скриптов
НЕ создавать скрипты (shell, PowerShell, bash и т.д.) автоматически, если пользователь явно не запросил создание скрипта. Создавать скрипты только когда пользователь явно просит:
- "создай скрипт"
- "напиши скрипт"
- "сделай скрипт"
- "автоматизируй через скрипт"
- или похожие явные запросы

Если задача может быть решена без скрипта (например, через прямые команды или изменения в коде), не предлагать и не создавать скрипты.

## Документация
Всю документацию (README.md, инструкции, руководства, API документацию и т.д.) необходимо хранить в папке `docs` в корне проекта. 

- README файлы для отдельных модулей (например, `backend/README.md`, `frontend/README.md`) можно оставлять в соответствующих папках
- Общую документацию проекта, инструкции по развертыванию, архитектурные решения и другую проектную документацию размещать в `docs/`
- При создании новой документации предлагать размещение в `docs/`, если это не специфичный README для модуля

